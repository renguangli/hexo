---
title: 关于Java对象，你需要知道的知识
tags: Java
date: 2020-10-19 11:17:27
---

有关 java 对象的一些知识

- [对象的创建过程](#对象的创建过程)
- [对象的分配过程](#对象的分配过程)
- [对象的内存布局](#对象的内存布局)
- [对象的大小](#对象的大小)
- [对象如何定位](#对象如何定位)

<!-- more -->

# 对象的创建过程

Object o = new Object();

如果对象所属的类还没有加载，需要先进行类加载，类加载包含以下 5 个阶段
- 加载 ：将 class 文件加载到 jvm 的方法区中
- 验证 ：验证 class 文件内容是否符合 jvm 规范
- 准备 : 为静态变量赋默认值，执行静态块
- 解析 ：符号引号转化为直接引用
- 初始化 ：为静态变量赋初始值

类加载完成后开始创建对象，创建对象包含以下 4 个阶段

- new : 为对象分配内存，成员变量赋默认值，并将对象引用压入操作数栈顶
- dup ：复制对象的引用，压入栈顶
- invokespecial : 对象引用出栈，调用构造方法
- astore_n : 对象引用出栈并赋值给第 n 个变量

# 对象的分配过程

栈上分配 -> tlab（thread local allocation buffer） -> eden -> turning 

对象年龄到达 15 或者 6 （cms）进入老年代

**栈上分配**

- 逃逸分析
- 标量替换

# 对象的内存布局

**普通对象** 包含对象头、实例数据、对象填充，其中对象头有包含 markword 和 klass pointer
**数组对象** 会增加 4 字节 array length

# 对象的大小

Object o = new Object() 内存大小为多少？

``` java
-XX:+UseCompressedClassPointers 开启类型指针压缩
-XX:+UseCompressedOops 开启普通对象指针压缩 oops(ordinary object points)
```

## 在类型指针和普通对象指针压缩未开启的情况下

在 64 为虚拟机中 

- markword 占 8 个字节
- Klass pointer 占 8 个字节
- 实例数据为 0,
- 8 + 8 = 16 是 8 的倍数，所以没有对齐填充
- 加上对象引用 o 为 8 个字节

所以 Object o = new Object() 占用 8 + 8 + 8 = 24 个字节

## 在类型指针和普通对象指针压缩开启的情况下

在 64 为虚拟机中 

- markword 占 8 个字节
- Klass pointer 由于开启了类型指针压缩，占 4 个字节
- 实例数据为 0,
- 8 + 8 = 12 不是 8 的倍数，所以对齐填充为 4 个字节
- 由于开启了普通对象指针压缩，所以对象引用 o 为 4 个字节

所以 Object o = new Object() 占用 8 + 4 + 4 + 4 = 20 个字节

# 对象如何定位

句柄池 ： 对象引用存储的是句柄池，句柄池包含对象的应用和类型指针

直接引用 ： 对象引用存储的为对象的内存地址，对象的寻址比较快