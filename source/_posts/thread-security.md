---
title: 8 种保证线程安全的技术你都知道吗
categories: Java
link_reprint:
  - url: https://zhuanlan.zhihu.com/p/262870289
    title: 这8种保证线程安全的技术你都知道吗？
---

并发情况下如何保证数据安全，一直都是开发人员每天都要面对的问题，稍不注意就会出现数据异常，造成不可挽回的结果。

<!-- more -->

笔者根据自己的实际开发经验，总结了下面几种保证数据安全的技术手段

- 无状态
- 不可变
- 安全的发布
- volatile
- synchronized
- lock
- cas
- threadlocal

# 无状态

多线程访问共享资源时才会有线程安全问题，如果没有共享资源就没有了线程安全问题。

# 不可变

如果多线程访问的共享资源是不可变的，也就不会有有线程安全问题了。

# 安全发布

如果类中有共享资源，但是没有对外开放访问权限，即对外安全发布，也没有线程安全问题

# volatile

如果有些公共资源只是一个开关，只要求可见性，不要求原子性，这样可以用 volatile 关键字修饰共享资源来解决问题。

# synchronized

使用 JDK 提供的同步机制，这也是使用比较多的手段，分为：方法同步 和 代码块同步，我们优先使用代码块同步，因为方法同步的范围更大，更消耗性能。每个对象内部都有一把锁，只有抢到那把锁的线程，才能进入代码块里，代码块执行完或者发生异常后，会自动释放锁。

# lock

除了使用 synchronized 关键字实现同步功能之外，JDK 还提供了 lock 显示锁的方式。它包含：可重入锁、读写锁 等更多更强大的功能，有个小问题就是需要手动释放锁，不过在编码时提供了更多的灵活性。

# cas

JDK 除了使用锁的机制解决多线程情况下数据安全问题之外，还提供了cas 机制。这种机制是使用 CPU 中比较和交换指令的原子性，JDK 是通过 Unsafe 类实现的。cas 需要四个值：旧值、期望值、新值 和 地址，比较旧值和 期望值，如果一样的话，就把旧值改成新值，当前线程不断自旋，一直到成功为止。不过可能会出现 aba 问题，需要使用 AtomicStampedReference 类增加版本号解决。

# threadlocal

除了上面几种解决思路之外，JDK 还提供了另外一种用空间换时间的新思路：threadlocal。它的核心思想是：共享变量在每个线程都有一个副本，每个线程操作的都是自己的副本，对另外的线程没有影响。特别注意，使用 threadlocal 时，使用完之后，要记得调用 remove 方法，不然可能会出现内存泄露问题。

# 总结

本文介绍了 8 种多线程情况下保证数据安全的技术手段，当然实际工作中可能会有其他手段。技术没有好坏之分，主要是看使用的场景，需要在不同的场景下使用不同的技术。